const DEFAULT_MENU = `
@lun
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@mar
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@mer
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@gio
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@ven
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@sab
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00

@dom
# Antipasti
Arancino di riso | 3.50 | Dorato e cremoso, come da tradizione
Caponata siciliana | 6.00 | Melanzane in agrodolce, profumo di basilico
Panelle | 4.50 | Farina di ceci, limone e sale

# Primi
Pasta alla norma | 9.00 | Pomodoro, melanzane, ricotta salata
Casarecci al pistacchio | 10.00 | Pistacchio, olio, pepe nero
Ragu della casa | 9.50 | Lento e avvolgente, servito con pasta fresca

# Secondi
Pesce spada alla griglia | 12.00 | Limone, olio e origano
Involtini di pesce spada | 12.00 | Ripieno morbido e saporito
Polpette al sugo | 10.00 | Ricetta di famiglia

# Contorni
Insalata di stagione | 4.00 | Verdure fresche di mercato
Patate al forno | 4.50 | Rosmarino e sale grosso

# Dolci
Cannolo siciliano | 4.50 | Ricotta, scorza e granella
Torta di casa | 4.50 | Dolce del giorno

# Bevande
Acqua naturale o frizzante | 2.00
Vino della casa | 4.00
Birra artigianale | 5.00
`;

let revealObserver;
let menuData = null;

const DAY_ORDER = ["lun", "mar", "mer", "gio", "ven", "sab", "dom"];
const DAY_LABELS = {
  lun: "Lun",
  mar: "Mar",
  mer: "Mer",
  gio: "Gio",
  ven: "Ven",
  sab: "Sab",
  dom: "Dom",
};

function normalizeDay(value) {
  if (!value) {
    return null;
  }
  const key = value.trim().toLowerCase();
  return DAY_LABELS[key] ? key : null;
}

function parseMenu(text) {
  const lines = text.split(/\r?\n/);
  const days = {};
  let currentDay = null;
  let current = null;

  function ensureDay(dayKey) {
    if (!days[dayKey]) {
      days[dayKey] = [];
    }
  }

  lines.forEach((rawLine) => {
    const line = rawLine.trim();
    if (!line || line.startsWith("//") || line.startsWith(";")) {
      return;
    }

    if (line.startsWith("@")) {
      const dayKey = normalizeDay(line.replace("@", ""));
      if (dayKey) {
        currentDay = dayKey;
        ensureDay(currentDay);
        current = null;
      }
      return;
    }

    if (line.startsWith("#")) {
      const title = line.replace(/^#+\s*/, "").trim();
      if (!title) {
        return;
      }
      if (!currentDay) {
        currentDay = "lun";
        ensureDay(currentDay);
      }
      current = { title, items: [] };
      days[currentDay].push(current);
      return;
    }

    const parts = line.split("|").map((part) => part.trim());
    const name = parts[0];
    const price = parts[1] || "";
    const desc = parts[2] || "";

    if (!name) {
      return;
    }

    if (!current) {
      if (!currentDay) {
        currentDay = "lun";
        ensureDay(currentDay);
      }
      current = { title: "Menu", items: [] };
      days[currentDay].push(current);
    }

    current.items.push({ name, price, desc });
  });

  return { days };
}

function renderMenu(sections) {
  const grid = document.querySelector("#menu-grid");
  if (!grid) {
    return;
  }

  grid.innerHTML = "";

  if (!sections || sections.length === 0) {
    const empty = document.createElement("div");
    empty.className = "menu-empty";
    empty.textContent = "Menu della settimana non disponibile.";
    grid.appendChild(empty);
    return;
  }

  sections.forEach((section) => {
    const card = document.createElement("div");
    card.className = "menu-section";
    card.setAttribute("data-reveal", "");

    const title = document.createElement("h3");
    title.textContent = section.title;
    card.appendChild(title);

    const list = document.createElement("div");
    list.className = "menu-items";

    section.items.forEach((item) => {
      const row = document.createElement("div");
      row.className = "menu-item";

      const left = document.createElement("div");
      const name = document.createElement("h4");
      name.textContent = item.name;
      left.appendChild(name);

      if (item.desc) {
        const desc = document.createElement("p");
        desc.className = "desc";
        desc.textContent = item.desc;
        left.appendChild(desc);
      }

      row.appendChild(left);

      if (item.price) {
        const price = document.createElement("div");
        price.className = "price";
        price.textContent = item.price;
        row.appendChild(price);
      }

      list.appendChild(row);
    });

    card.appendChild(list);
    grid.appendChild(card);
    observeReveal(card);
  });
}

function renderDayButtons() {
  const container = document.querySelector("#menu-days");
  if (!container) {
    return;
  }

  container.innerHTML = "";
  DAY_ORDER.forEach((dayKey) => {
    const button = document.createElement("button");
    button.type = "button";
    button.className = "day-button";
    button.dataset.day = dayKey;
    button.textContent = DAY_LABELS[dayKey];
    const sections = menuData && menuData.days ? menuData.days[dayKey] : null;
    button.disabled = !sections || sections.length === 0;
    button.addEventListener("click", () => setActiveDay(dayKey));
    container.appendChild(button);
  });
}

function setActiveDay(dayKey) {
  if (!menuData || !menuData.days) {
    return;
  }
  const sections = menuData.days[dayKey] || [];
  renderMenu(sections);
  const buttons = document.querySelectorAll(".day-button");
  buttons.forEach((button) => {
    const isActive = button.dataset.day === dayKey;
    button.classList.toggle("is-active", isActive);
    button.setAttribute("aria-pressed", isActive ? "true" : "false");
  });
}

function getTodayKey() {
  const today = new Date().getDay();
  const index = (today + 6) % 7;
  return DAY_ORDER[index];
}

function getDefaultDay() {
  const todayKey = getTodayKey();
  if (menuData.days[todayKey] && menuData.days[todayKey].length) {
    return todayKey;
  }
  const firstAvailable = DAY_ORDER.find((day) => menuData.days[day] && menuData.days[day].length);
  return firstAvailable || DAY_ORDER[0];
}

function getIsoWeekNumber(date = new Date()) {
  const temp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const day = temp.getUTCDay() || 7;
  temp.setUTCDate(temp.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(temp.getUTCFullYear(), 0, 1));
  const week = Math.ceil(((temp - yearStart) / 86400000 + 1) / 7);
  return week;
}

async function fetchMenuText(fileName) {
  const response = await fetch(fileName, { cache: "no-store" });
  if (!response.ok) {
    throw new Error("Menu fetch failed");
  }
  return response.text();
}

async function loadMenu() {
  const weekNumber = getIsoWeekNumber();
  const isEvenWeek = weekNumber % 2 === 0;
  const primaryFile = isEvenWeek ? "menu2.txt" : "menu.txt";
  const fallbackFile = isEvenWeek ? "menu.txt" : "menu2.txt";

  try {
    const text = await fetchMenuText(primaryFile);
    menuData = parseMenu(text);
  } catch (error) {
    try {
      const text = await fetchMenuText(fallbackFile);
      menuData = parseMenu(text);
    } catch (fallbackError) {
      menuData = parseMenu(DEFAULT_MENU);
    }
  }
  renderDayButtons();
  setActiveDay(getDefaultDay());
}

function revealOnScroll() {
  const elements = document.querySelectorAll("[data-reveal]");
  revealObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          const delay = Math.min(index * 60, 360);
          entry.target.style.transitionDelay = `${delay}ms`;
          entry.target.classList.add("is-visible");
          revealObserver.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.2 }
  );

  elements.forEach((el) => revealObserver.observe(el));
}

function observeReveal(element) {
  if (!revealObserver) {
    return;
  }
  revealObserver.observe(element);
}

function trackEvent(name, props) {
  if (!name) {
    return;
  }

  if (window.plausible) {
    window.plausible(name, { props: props || {} });
    return;
  }

  if (window.umami && typeof window.umami.track === "function") {
    window.umami.track(name, props || {});
    return;
  }

  if (window.gtag) {
    window.gtag("event", name, props || {});
  }
}

function bindTracking() {
  const trackables = document.querySelectorAll("[data-track]");
  trackables.forEach((element) => {
    element.addEventListener("click", () => {
      trackEvent(element.dataset.track);
    });
  });
}

function loadEmbed(embed) {
  if (!embed || embed.classList.contains("is-loaded")) {
    return;
  }

  const type = embed.dataset.embedType;
  const src = embed.dataset.embedSrc;
  const slot = embed.querySelector("[data-embed-slot]");
  if (!slot) {
    return;
  }

  if (type === "map") {
    const iframe = document.createElement("iframe");
    iframe.title = "Mappa Dal Barbuto - Via Pietro Novelli 155, Canalicchio (Catania)";
    iframe.src = src;
    iframe.loading = "lazy";
    iframe.referrerPolicy = "no-referrer-when-downgrade";
    iframe.allowFullscreen = true;
    slot.appendChild(iframe);
  } else {
    return;
  }

  embed.classList.add("is-loaded");
}

function setupConsentEmbeds() {
  const embeds = document.querySelectorAll(".consent-embed");
  embeds.forEach((embed) => {
    const button = embed.querySelector("[data-embed-load]");
    if (!button) {
      return;
    }
    button.addEventListener("click", () => loadEmbed(embed));
  });
}

function setupMobileTopbar() {
  const topbar = document.querySelector(".topbar");
  if (!topbar) {
    return;
  }

  const mediaQuery = window.matchMedia("(max-width: 900px)");
  let ticking = false;

  const update = () => {
    ticking = false;
    if (!mediaQuery.matches) {
      topbar.classList.remove("is-compact");
      return;
    }
    const shouldCompact = window.scrollY > 20;
    topbar.classList.toggle("is-compact", shouldCompact);
  };

  const onScroll = () => {
    if (ticking) {
      return;
    }
    ticking = true;
    window.requestAnimationFrame(update);
  };

  window.addEventListener("scroll", onScroll, { passive: true });
  window.addEventListener("resize", update);
  if (typeof mediaQuery.addEventListener === "function") {
    mediaQuery.addEventListener("change", update);
  } else if (typeof mediaQuery.addListener === "function") {
    mediaQuery.addListener(update);
  }

  update();
}

document.addEventListener("DOMContentLoaded", () => {
  revealOnScroll();
  loadMenu();
  setupConsentEmbeds();
  bindTracking();
  setupMobileTopbar();
});
